<form
  [formGroup]="occurrenceForm" 
  (ngSubmit)="openConfirmActionDialog(occurrenceForm.value)" >

  <mat-card-content id='occurrence-form-container' >
      
      <div class="occurrence-form-left-column">

        <div class="occurrence-form-header">
        </div>

        <div class="occurrence-form-column-title">Données relatives à l'observation</div>

          <div class="occurrence-form-label-container">
            <label class="occurrence-form-label">Localisation :</label>
          </div>

          <div class="geoloc-map">
            <tb-geoloc-map
              [reset]='resetForm'
              [patchElevation]="patchElevation"
              [patchGeometry]="patchGeometry"
              [elevationProvider]="elevationApiProvider"
              [osmTilesLayerApi]="mapBgTileUrl"
              [patchLngLatDec]="patchLatLngDec"
              [patchAddress]="patchAddress"
              (location)='onLocationChange($event)'
            ></tb-geoloc-map>
          </div>

          <div class="occurrence-form-label-container">
            <label class="occurrence-form-label">Localisation diffusée (floutage) :</label>
          </div>
          <mat-form-field>
            <select matNativeControl [(ngModel)]="publishedLocationSelected" formControlName="publishedLocation">
              <option value="précise">précise</option>
              <option value="localité">localité</option>
              <option value="10x10km">10x10km</option>
            </select>
          </mat-form-field>

          <div class="occurrence-form-label-container">
            <label class="occurrence-form-label">Date de l'observation :</label>
          </div>
          <section class="observed-date-form-field-container">
            <mat-form-field>
              <input matInput readonly [matDatepicker]="dateObserved" formControlName="dateObserved">
              <mat-datepicker-toggle matSuffix [for]="dateObserved"></mat-datepicker-toggle>
              <mat-datepicker #dateObserved></mat-datepicker>
            </mat-form-field>
          </section>

          <!-- Advanced form fields container -->
          <section class="advanced-form-left-container" *ngIf="displayFullFormLeft">

            <!-- Advanced form fields container - left column -->
            <div class="advanced-form-left-left" >   

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Lieu-dit :</label>
              </div>
              <mat-form-field>
                <input matInput formControlName="sublocality">
              </mat-form-field>

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Milieu :</label>
              </div>
              <mat-form-field>
                <input matInput formControlName="environment">
              </mat-form-field>


              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Projet :</label>
              </div>
              <mat-form-field>
                  <mat-label></mat-label>
                      <mat-select [(value)]="projectId" (selectionChange)="changeProjectId(project.id)">
                      <mat-option *ngFor="let project of projects" value="{{project.id}}">{{project.label}}</mat-option>
                  </mat-select>
              </mat-form-field>

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Structure :</label>
              </div>
              <mat-form-field>
                <input matInput formControlName="observerInstitution">
              </mat-form-field>

            </div>

            <!-- Advanced form fields container - right column -->
            <div class="advanced-form-left-right" >

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Station :</label>
              </div>
              <mat-form-field>
                <input matInput formControlName="station">
              </mat-form-field>

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Précision de la localisation :</label>
              </div>
              <mat-form-field>
                <select matNativeControl formControlName="locationAccuracy">
                  <option value="0 à 10 m">0 à 10 m</option>
                  <option value="10 à 100 m">10 à 100 m</option>
                  <option value="100 à 500 m">100 à 500 m</option>
                  <option value="Lieu-dit">Lieu-dit</option>
                  <option value="Localité">Localité</option>
                </select>
              </mat-form-field>

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Observateur :</label>
              </div>
              <mat-form-field>
                <input matInput formControlName="observer">
              </mat-form-field>


          </div>
          </section>

          <div class="occurrence-form-options">
            <div>
            <span class="occurrence-form-option-label">Afficher les champs avancés</span>
            <mat-slide-toggle [checked]="false" (toggleChange)="toggleAdvancedFormLeft($event)" ></mat-slide-toggle>
            </div>
            <div *ngIf="isInCreateMode()">
              <span class="occurrence-form-option-label">Réinitialiser ces données pour l'observation suivante</span>
              <mat-slide-toggle (toggleChange)="toggleClearFormAfterSubmit($event)" ></mat-slide-toggle>
            </div>

          </div>

      </div>

      <div class="occurrence-form-right-column">

        <div class="occurrence-form-header">
          <button type="button" mat-button (click)="navigateToHelp()">Aide</button>
        </div>

        <div class="occurrence-form-column-title">Qu'avez-vous observé ?</div>

        <div>

          <div class="occurrence-form-label-container">
              <label class="occurrence-form-label">Taxon :</label>
          </div>

          <div class="tsb-search-box">
            <tb-tsb-search-box 
              placeholder='Choisir une espèce'
              editingPlaceholder="Modifier l'espèce"
              defaultRepository='bdtfx'
              [autoSelectValueIfOnlyOneResult]='autoSelectValueIfOnlyOneResult'
              [tbRepositoriesConfig]='tbRepositoriesConfig'
              [autoResetWhenSelected]='false'
              [emitOccurenceOnBlur]='true'
              [reset]='resetForm'
              [updateData]='patchTaxon'
              (updatedData)='onTaxonChange($event)'
              (newData)='onTaxonChange($event)'></tb-tsb-search-box>
          </div>

          <button type="button" mat-button (click)="displayEfloreCard()" [disabled]="!isEfloreCardDisplayable()">Consulter la fiche eFlore</button>

          <section class="base-occurrence-form-section">
            <div class="occurrence-form-label-container">
              <label class="occurrence-form-label">Certitude :</label>
            </div>
            <mat-radio-group  formControlName="certainty" class="certainty-selector">
              <mat-radio-button class="example-margin" value="certain">Certaine</mat-radio-button>
              <mat-radio-button class="example-margin" value="douteux">Douteuse</mat-radio-button>
              <mat-radio-button class="example-margin" value="à déterminer">A déterminer</mat-radio-button>
            </mat-radio-group>
          </section>
        </div>

          <div class="occurrence-form-annotation-photo-container">

            <div class="occurrence-form-photo-container">
              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Ajouter une photo :</label>
              </div>
               <!-- (geolocatedPhotoLatLng)="geolocatedPhotoData($event)" --> 
              <tb-dropfile-box
                [reset]="resetForm" 
                [showTable]="true" 
                [uploadTbPhotoFiles]="true"
                [label]="'Glissez vos photos ici'"
                [ignoreOversizedFiles]="false"
                [photoUploadBaseUrl]="baseCelApiUrl"   
                (httpError)="onPostPhotoError($event)"
                (rejectedFiles)="onPhotoRejected($event)"
                (acceptedFiles)="onPhotoAdded($event)"
                (uploadedFiles)="onPhotoUploaded($event)"
              ></tb-dropfile-box>
            </div>

            <div class="occurrence-form-annotation-container">

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Commentaire :</label>
              </div>

              <mat-form-field style="width:100%;">
                <textarea matInput formControlName="annotation"></textarea>
              </mat-form-field>
            </div>
          </div>

          <button mat-button type="button" (click)="openLinkPhotoDialog()">Choisir une photo déjà importée</button>
          <button mat-button type="button" (click)="askPlantNet()" [disabled]="!isPlantNetCallable()">Aide à la détermination avec PlantNet</button>

          <div class="occurrence-form-label-container">
            <label class="occurrence-form-label">Spontanéité :</label>
          </div>
            <mat-radio-group [(ngModel)]="isWildSelected" formControlName="isWild">  
            <mat-radio-button *ngFor="let op of isWildList" [value]="op.value">{{op.name}}</mat-radio-button>
          </mat-radio-group>



          <div *ngIf="isTagComponentDisplayable()">
            <div class="occurrence-form-label-container">
              <label class="occurrence-form-label">Mots-clés :</label>
            </div>
            <tb-tag
              [userId]=22
              [objectId]="tagObjectId"
              [noApiCall]="delayTagApiCalls()"
              [basicTags]="basicTags"
              [baseApiUrl]="tagLibBaseUrl"
              (newTag)="onTagAdded($event)"
              (removedTag)="onTagRemoved($event)"
              (httpError)="onPostTagError($event)"
              apiPath="/api/user_occurrence_tags"
              apiRelationPath="/api/occurrence_user_occurrence_tag_relations"
              apiRetrievePath="/api/occurrence/{id}/occurrence_user_occurrence_tag_relations"
              objectName="occurrence"
              objectEndpoint="/api/occurrences"
              tagName="userOccurrenceTag"
              tagEndpoint="/api/user_occurrence_tags"></tb-tag>
          </div>

        
          <div class="occurrence-form-label-container">
            <label class="occurrence-form-label">Options de publication :</label>
          </div>
          <mat-slide-toggle formControlName="isPublic" [disabled]="!isPublishable()" checked="false" >Observation publique</mat-slide-toggle>

          <!-- Advanced form fields container -->
          <section class="advanced-form-left-container" *ngIf="displayFullFormRight">

            <!-- Advanced form fields container - left column -->
            <div class="advanced-form-left-left" >       



              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Type de donnée :</label>
              </div>
              <mat-form-field>
                <select matNativeControl [(ngModel)]="occurrenceTypeSelected" formControlName="occurrenceType">
                  <option value="observation de terrain">observation de terrain</option>
                  <option value="issue de la bibliographie">issue de la bibliographie</option>
                  <option value="donnée d'herbier">donnée d'herbier</option>
                </select>
              </mat-form-field>

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Phénologie :</label>
              </div>
              <mat-form-field>
                <select matNativeControl formControlName="phenology">
                  <option value="00-09: germination, développement des bourgeons">00-09: germination, développement des bourgeons</option>
                  <option value="10-19: développement des feuilles">10-19: développement des feuilles</option>
                  <option value="11: par ex, environ 10% des feuilles épanouies">11: par ex, environ 10% des feuilles épanouies</option>
                  <option value="15: par ex, environ 50% des feuilles épanouies">15: par ex, environ 50% des feuilles épanouies</option>
                  <option value="20-29: formation de pousses latérales, tallage">20-29: formation de pousses latérales, tallage</option>
                  <option value="30-39: développement des tiges, croissance des rosettes">30-39: développement des tiges, croissance des rosettes</option>
                  <option value="40-49: développement des organes de propagation végétative">40-49: développement des organes de propagation végétative</option>
                  <option value="60-69: floraison">floraison</option>
                  <option value="61: par ex, environ 10% des fleurs épanouies">61: par ex, environ 10% des fleurs épanouies</option>
                  <option value="65: par ex, environ 50% des fleurs épanouies">65: par ex, environ 50% des fleurs épanouies</option>
                  <option value="70-79: fructification">70-79: fructification</option>
                  <option value="80-89: maturité des fruits et des graines">80-89: maturité des fruits et des graines</option>
                  <option value="85: par ex, 50% des fruits matures">85: par ex, 50% des fruits matures</option>
                  <option value="90-99: sénescence et dormance">90-99: sénescence et dormance</option>
                  <option value="91: par ex, environ 10% des feuilles jaunes">91: par ex, environ 10% des feuilles jaunes</option>
                  <option value="95: par ex, environ 50% des feuilles jaunes">95: par ex, environ 50% des feuilles jaunes</option>
                </select>
              </mat-form-field>

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Abondance :</label>
              </div>
              <mat-form-field>
                <input matInput formControlName="coef">
              </mat-form-field>

              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Présence d'un témoin d'herbier :</label>
              </div>
              <mat-slide-toggle formControlName="herbariumSample"></mat-slide-toggle>

            </div>

            <!-- Advanced form fields container - right column -->
            <div class="advanced-form-left-right" >
            
              <div class="occurrence-form-label-container">
                <label class="occurrence-form-label">Source bibliographique :</label>
              </div>
              <mat-form-field>
                <input matInput formControlName="bibliographySource">
              </mat-form-field>

            </div>

          </section>

          <div class="occurrence-form-options">
            <span class="occurrence-form-option-label">Afficher les champs avancés</span>
            <mat-slide-toggle [checked]="false" (toggleChange)="toggleAdvancedFormRight($event)" ></mat-slide-toggle>
          </div>

    </div>

  </mat-card-content>

  <div class="occurrence-form-submit-button-container">
    <mat-card-actions align="center" >
      <button type="submit" mat-raised-button color="primary" >Enregistrer</button>
      <button type="button" mat-raised-button color="warn" (click)="onCancel()">Annuler</button>
    </mat-card-actions>
  </div>

</form>
